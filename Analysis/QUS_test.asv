%For processing QUS data from 3D bmode scans of reproductive tract tissues
%6/4/2024
%Updated 7/3/2025
ProcessIQ = true;
Segment = false;
ProcessQUS = false; 
OverlayQUS = false;

addpath(genpath('D:\Andrew\Repro_QUS\'));
data_dir = 'D:\Andrew\Prolapse Model';
cd(data_dir);
samples = dir('M805*');
date_str = char(datetime(datetime,"Format","uuuu-MM-dd"));
qus_file = strcat(date_str,'_qus_results.mat');
anatomy = readtable('anatomy_qus.csv');


for i = 1:length(samples)
    %Go to sample folder
    fid = samples(i).name;
    cd(fid);
    anatomy_table = anatomy(anatomy.ID == str2num(fid(2:end)),:);
    anatomy_array = table2array(anatomy_data(1,2:end));
    frame_num = max(anatomy_array);

    %Convert IQ data file into .mat file with RF data
    if ProcessIQ
        mat_file = repro.iq2rf(fid,frame_num);
    else
        mat_file = strcat(id,'_RF');
    end
      
    %Draw an ROI around the tissue, then a line on the surface
    if Segment
        repro.segment_repro_frames(mat_file,frame_num);
    end
    
    %Compute the QUS parameters in the entire image
    if ProcessQUS
        repro.qus_processing(mat_file,frame_num,qus_file);
    end
    
    %Create figures displaying the parameter maps
    if OverlayQUS
        repro.plot_bmode_qus_overlay(qus_file,frame_num);
    end
end

%For all of the samples
%Compile qus results into a table for data analysis
%List of paths to each RF data file
% fid_cell_array = {'E:\QPA\data2\G3_RF.mat';'E:\QPA\data\G0_RF.mat'};
%List of data IDs to lab
% id_cell_array = {'M955';'M830'};
% repro.compile_qus_results(qus_file,fid_cell_array,id_cell_array,frame_num);